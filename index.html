<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description"
        content="Joke Central - Get your daily dose of premium Dad Jokes, Programming Humor, and Puns.">
    <title>Joke Central | Premium Humor</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">

    <!-- Modern Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #10b981;
            --secondary-hover: #059669;
            --accent1: #f43f5e;
            --accent2: #f59e0b;
            --bg-gradient-1: #0f172a;
            --bg-gradient-2: #1e1b4b;
            --bg-gradient-3: #312e81;
            --text-main: #f8fafc;
            --text-muted: #cbd5e1;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-1), var(--bg-gradient-2), var(--bg-gradient-3));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: var(--text-main);
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Abstract Background Shapes */
        .bg-shape {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.5;
            animation: float 10s infinite ease-in-out alternate;
        }

        .shape-1 {
            top: -100px;
            left: -100px;
            width: 400px;
            height: 400px;
            background: rgba(79, 70, 229, 0.4);
            animation-delay: 0s;
        }

        .shape-2 {
            bottom: -150px;
            right: -100px;
            width: 500px;
            height: 500px;
            background: rgba(16, 185, 129, 0.3);
            animation-delay: -5s;
        }

        .shape-3 {
            top: 40%;
            left: 60%;
            width: 300px;
            height: 300px;
            background: rgba(244, 63, 94, 0.3);
            animation-delay: -2s;
        }

        @keyframes float {
            0% {
                transform: translateY(0) scale(1);
            }

            100% {
                transform: translateY(-30px) scale(1.1);
            }
        }

        #offline-banner {
            background: rgba(239, 68, 68, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            text-align: center;
            padding: 12px;
            display: none;
            position: sticky;
            top: 0;
            z-index: 1000;
            font-weight: 600;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .main-header {
            padding: 30px 0;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .main-header h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.8rem;
            background: linear-gradient(to right, #fff, #a5b4fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 20px rgba(79, 70, 229, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .main-header h1 i {
            -webkit-text-fill-color: initial;
            color: #fbbf24;
            filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.5));
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        .content-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 20px 40px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            z-index: 10;
        }

        /* Glassmorphism Card */
        .joke-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            padding: 40px 30px;
            border-radius: 30px;
            box-shadow: var(--glass-shadow);
            text-align: center;
            min-height: 380px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 100%;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .joke-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px 0 rgba(0, 0, 0, 0.4);
        }

        /* Card highlight accent */
        .joke-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent1));
        }

        .joke-text {
            font-size: 1.5rem;
            color: #ffffff;
            font-weight: 400;
            white-space: pre-wrap;
            margin-bottom: 35px;
            line-height: 1.6;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .buttons-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .button-primary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            height: 55px;
            border-radius: 14px;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            padding: 0 10px;
        }

        .button-primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: skewX(-20deg);
            transition: 0.5s;
        }

        .button-primary:hover::after {
            left: 150%;
        }

        .button-primary:active {
            transform: scale(0.95);
        }

        .btn-dad {
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            border: none;
        }

        .btn-code {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-hover));
            border: none;
        }

        .btn-pun {
            background: linear-gradient(135deg, var(--accent1), #e11d48);
            border: none;
        }

        .btn-rand {
            background: linear-gradient(135deg, var(--accent2), #d97706);
            border: none;
        }

        .btn-misc {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: none;
        }

        .btn-knock {
            background: linear-gradient(135deg, #ec4899, #be185d);
            border: none;
        }

        .btn-spooky {
            background: linear-gradient(135deg, #f97316, #ea580c);
            border: none;
        }

        .btn-xmas {
            background: linear-gradient(135deg, #14b8a6, #0d9488);
            border: none;
        }

        .btn-single {
            background: linear-gradient(135deg, #eab308, #a16207);
            border: none;
        }

        .action-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 1.4rem;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(5px);
        }

        .action-btn:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.2);
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        .action-btn i {
            transition: color 0.3s ease;
        }

        #fav-btn:hover i {
            color: #f43f5e;
        }

        #share-btn:hover i {
            color: #38bdf8;
        }

        .fav-section {
            width: 100%;
            animation: fadeIn 0.8s ease-out;
        }

        .fav-section h3 {
            margin-bottom: 20px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .fav-item {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .fav-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.08);
        }

        .fav-item p {
            font-size: 1.1rem;
            line-height: 1.5;
            flex-grow: 1;
        }

        .delete-btn {
            color: #f87171;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            align-self: flex-end;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 8px;
            background: rgba(248, 113, 113, 0.1);
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
        }

        .delete-btn:hover {
            background: #f87171;
            color: #fff;
        }

        .main-footer {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            color: var(--text-muted);
            text-align: center;
            padding: 30px 20px;
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 10;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .footer-link {
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .footer-link:hover {
            color: #fff;
        }

        /* Interactive Elements */
        .reveal-btn {
            background: linear-gradient(135deg, var(--accent2), #d97706);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .reveal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .rating-toast {
            position: absolute;
            font-size: 2rem;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            opacity: 0;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-50px) scale(1.5);
            }
        }

        .hidden-punchline {
            filter: blur(8px);
            transition: filter 0.5s ease;
            cursor: pointer;
        }

        .hidden-punchline.revealed {
            filter: blur(0);
            cursor: auto;
        }

        /* Modern loading animation */
        .spinner-container {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100px;
            margin-bottom: 35px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(#0000 10%, var(--primary));
            -webkit-mask: radial-gradient(farthest-side, #0000 40%, #000 41%);
            animation: sp-ani 0.8s infinite linear;
        }

        @keyframes sp-ani {
            100% {
                transform: rotate(1turn);
            }
        }

        /* Toast Notification System */
        #toast-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), fadeOut 0.3s ease 2.7s forwards;
            opacity: 1;
        }

        .toast.success i {
            color: #10b981;
        }

        .toast.error i {
            color: #f43f5e;
        }

        .toast.info i {
            color: #38bdf8;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Mobile Adjustments */
        @media (max-width: 480px) {
            .main-header h1 {
                font-size: 2.2rem;
            }

            .joke-text {
                font-size: 1.3rem;
            }

            .joke-card {
                padding: 30px 20px;
                border-radius: 20px;
            }

            .buttons-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .button-primary {
                font-size: 0.95rem;
                height: 55px;
            }
        }

        /* Search & Bulk Management */
        .mgmt-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
        }

        .search-wrapper {
            position: relative;
            flex-grow: 1;
        }

        .search-wrapper i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 15px 12px 40px;
            color: #fff;
            font-family: 'Outfit', sans-serif;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.2);
        }

        .btn-mgmt {
            padding: 0 15px;
            height: 46px;
            font-size: 0.9rem;
            border-radius: 12px;
        }
    </style>
</head>

<body>

    <!-- Audio Elements -->
    <audio id="sfx-rimshot" src="audio/rimshot.mp3" preload="auto"></audio>
    <audio id="sfx-crickets" src="audio/crickets.mp3" preload="auto"></audio>

    <!-- Background Shapes -->
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="bg-shape shape-3"></div>

    <div id="offline-banner"><i class="ri-wifi-off-line"></i> Offline Mode - Showing cached logic</div>

    <header class="main-header">
        <h1>Joke Central <i class="ri-emoji-sticker-fill"></i></h1>
    </header>

    <main class="content-area">
        <div class="joke-card">

            <div class="spinner-container" id="loader">
                <div class="spinner"></div>
            </div>

            <p id="joke-text" class="joke-text">Press a category below to generate your first premium laugh!</p>

            <div class="buttons-container">
                <button class="button-primary btn-dad fetch-btn" data-type="dad" aria-label="Fetch Dad Joke">
                    <i class="ri-parent-line"></i> Dad Joke
                </button>
                <button class="button-primary btn-code fetch-btn" data-type="Programming"
                    aria-label="Fetch Coding Joke">
                    <i class="ri-code-s-slash-line"></i> Coding
                </button>
                <button class="button-primary btn-pun fetch-btn" data-type="Pun" aria-label="Fetch Pun">
                    <i class="ri-chat-smile-3-line"></i> Puns
                </button>
                <button class="button-primary btn-misc fetch-btn" data-type="geek" aria-label="Fetch Geek Joke"
                    style="background: linear-gradient(135deg, #0ea5e9, #0284c7);">
                    <i class="ri-terminal-box-line"></i> Geek Jokes
                </button>
                <button class="button-primary btn-spooky fetch-btn" data-type="Spooky" aria-label="Fetch Spooky Joke">
                    <i class="ri-ghost-line"></i> Spooky
                </button>
                <button class="button-primary btn-xmas fetch-btn" data-type="chuck"
                    aria-label="Fetch Chuck Norris Truth"
                    style="background: linear-gradient(135deg, #ea580c, #c2410c);">
                    <i class="ri-fire-line"></i> Chuck Norris
                </button>
            </div>

            <div class="action-bar">
                <button id="tts-btn" class="action-btn" aria-label="Read Joke Aloud" title="Read Aloud">
                    <i class="ri-volume-up-line"></i>
                </button>
                <button id="upvote-btn" class="action-btn" aria-label="Good Joke" title="Upvote">
                    <i class="ri-thumb-up-line"></i>
                </button>
                <button id="downvote-btn" class="action-btn" aria-label="Bad Joke" title="Downvote">
                    <i class="ri-thumb-down-line"></i>
                </button>
                <button id="fav-btn" class="action-btn" aria-label="Save to Favorites" title="Save Joke">
                    <i class="ri-heart-3-line"></i>
                </button>
                <button id="share-btn" class="action-btn" aria-label="Share Joke" title="Share Joke">
                    <i class="ri-share-forward-line"></i>
                </button>
            </div>
        </div>

        <section class="fav-section">
            <h3><i class="ri-bookmark-3-line" style="color:var(--secondary)"></i> Saved Hall of Fame</h3>

            <div class="mgmt-controls">
                <div class="search-wrapper">
                    <i class="ri-search-line"></i>
                    <input type="text" id="fav-search" class="search-input" placeholder="Search saved jokes...">
                </div>
                <button id="copy-all-btn" class="button-primary btn-mgmt" title="Copy All Favorites">
                    <i class="ri-file-copy-line"></i> Copy All
                </button>
            </div>

            <div id="fav-list">
                <!-- Favorites injected here -->
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <p>&copy; <span id="current-year"></span> Premium Joke Central. Developed with laughter.</p>
        <div class="footer-links">
            <a href="javascript:void(0)" id="report-btn" class="footer-link"><i class="ri-flag-line"></i> Report
                Joke</a>
            <a href="privacy policy.html" class="footer-link"><i class="ri-shield-check-line"></i> Privacy Policy</a>
        </div>
    </footer>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <script>
        // --- UI Utilities System ---
        const UI = {
            toastContainer: document.getElementById('toast-container'),

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                let iconClass = 'ri-information-line';
                if (type === 'success') iconClass = 'ri-checkbox-circle-line';
                if (type === 'error') iconClass = 'ri-error-warning-line';
                if (type === 'heart') iconClass = 'ri-heart-3-fill';

                toast.innerHTML = `<i class="${iconClass}"></i> <span>${message}</span>`;
                this.toastContainer.appendChild(toast);

                // Cleanup after animation finishes maping to CSS 3s (0.3s delay + 2.7s animation)
                setTimeout(() => {
                    if (toast.parentNode) toast.parentNode.removeChild(toast);
                }, 3000);
            },

            haptic() {
                if (navigator.vibrate) try { navigator.vibrate(25); } catch (e) { }
            },

            escapeHTML(str) {
                return str.replace(/[&<>'"]/g, tag => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
                }[tag]));
            }
        };

        // --- App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const jokeTextElement = document.getElementById('joke-text');
            const favList = document.getElementById('fav-list');
            const loader = document.getElementById('loader');
            const favBtnIcon = document.querySelector('#fav-btn i');
            const ttsBtnIcon = document.querySelector('#tts-btn i');

            // --- Ultimate Variety System (No-Repeat Logic) ---
            let seenJokes = JSON.parse(localStorage.getItem('jokeSeenHistory')) || [];
            const MAX_SEEN_HISTORY = 50;

            function isJokeSeen(text) {
                // Normalize text for comparison by removing punctuation and extra spaces
                const cleanText = text.toLowerCase().replace(/[^\w\s]/gi, '').trim();
                return seenJokes.some(seen => seen.toLowerCase().replace(/[^\w\s]/gi, '').trim() === cleanText);
            }

            function markJokeSeen(text) {
                if (!isJokeSeen(text)) {
                    seenJokes.unshift(text);
                    if (seenJokes.length > MAX_SEEN_HISTORY) seenJokes.pop();
                    localStorage.setItem('jokeSeenHistory', JSON.stringify(seenJokes));
                }
            }

            // --- Massive Local Fallback Database (100+ Unique Jokes) ---
            const localDadJokes = [
                "I'm afraid for the calendar. Its days are numbered.",
                "My wife said I should do lunges to stay in shape. That would be a big step forward.",
                "Why do fathers take an extra pair of socks when they go golfing? In case they get a hole in one!",
                "Singing in the shower is fun until you get soap in your mouth. Then it's a soap opera.",
                "What do you call a factory that makes okay products? A satisfactory.",
                "Dear Math, grow up and solve your own problems.",
                "What did the janitor say when he jumped out of the closet? Supplies!",
                "Have you heard about the chocolate record player? It sounds pretty sweet.",
                "I only know 25 letters of the alphabet. I don't know y.",
                "How do you make a tissue dance? You put a little boogie in it.",
                "Why did the bullet end up losing his job? He got fired.",
                "What kind of shoes do ninjas wear? Sneakers.",
                "How does a penguin build its house? Igloos it together.",
                "What do you call a belt made out of watches? A waist of time.",
                "What do you call a pile of cats? A meowntain.",
                "Why did the scarecrow win an award? Because he was outstanding in his field.",
                "What do you call a fake noodle? An impasta.",
                "Why can't a bike stand up by itself? Itâ€™s two Tired.",
                "Why don't skeletons fight each other? They don't have the guts.",
                "What do you call a pencil with two erasers? Pointless.",
                "I used to be a baker, but I couldn't make enough dough.",
                "Why did the math book look sad? Because it had too many problems.",
                "I'm on a seafood diet. I see food and I eat it.",
                "What did the ocean say to the beach? Nothing, it just waved.",
                "Why did the golfer bring two pairs of pants? In case he got a hole in one.",
                "What do you call a fly without wings? A walk.",
                "Why did the cow go to outer space? To see the mooooooon.",
                "What did one wall say to the other? I'll meet you at the corner.",
                "Why did the chicken cross the playground? To get to the other slide.",
                "What do you call a bear with no teeth? A gummy bear.",
                "Why did the tomato turn red? Because it saw the salad dressing.",
                "How do you organize a space party? You planet.",
                "Why did the kid throw his clock out the window? He wanted to see time fly.",
                "What do you call an alligator in a vest? An investigator.",
                "What do you call an elephant that doesn't matter? An irrelephant.",
                "How do you catch a squirrel? Climb a tree and act like a nut.",
                "Why did the picture go to jail? Because it was framed.",
                "What do you call a sleeping dinosaur? A dino-snore.",
                "Why do fish live in salt water? Because pepper makes them sneeze.",
                "What do you call a snowman with a six pack? An abdominal snowman.",
                "Why did the man put his money in the freezer? He wanted cold hard cash.",
                "How do you make a lemon drop? Just let it fall.",
                "What do you call a dog that can do magic? A labracadabrador.",
                "Why did the bicycle fall over? Because it was two-tired.",
                "Why do bees have sticky hair? Because they use honeycombs.",
                "What do you call a skeleton who won't work? Lazy bones.",
                "Why did the pony get sent to his room? He wouldn't stop horsing around.",
                "What do you call a sheep with no legs? A cloud.",
                "Why did the computer go to the doctor? It had a virus.",
                "What do you call a fish with no eyes? Fsh."
            ];

            const localGenJokes = [
                "Real programmers count from 0.",
                "Why do programmers prefer dark mode? Because light attracts bugs.",
                "A SQL query walks into a bar, walks up to two tables, and asks, 'Can I join you?'",
                "How many programmers does it take to change a light bulb? None, it's a hardware problem.",
                "There are 10 types of people in the world: those who understand binary, and those who don't.",
                "To understand what recursion is, you must first understand what recursion is.",
                "A programmer's wife tells him, 'Go to the store and get a loaf of bread. If they have eggs, get a dozen.' He returns with 12 loaves of bread.",
                "Why did the developer go broke? Because he used up all his cache.",
                "What is the object-oriented way to become wealthy? Inheritance.",
                "Why do Java developers wear glasses? Because they don't C#.",
                "Knock, knock. Whoâ€™s there? (long pause) Java.",
                "An optimist says the glass is half full. A pessimist says the glass is half empty. A programmer says the glass is twice as large as it needs to be.",
                "Documentation is like sex; when it's good, it's very, very good, and when it's bad, it's better than nothing.",
                "Why do we programmer's always mix up Halloween and Christmas? Because Oct 31 == Dec 25.",
                "Hardware is the part of a computer you can kick; software is the part you can only curse at.",
                "In order to understand recursion, you must first understand recursion.",
                "Debugging: Being the detective in a crime movie where you are also the murderer.",
                "A user interface is like a joke. If you have to explain it, itâ€™s not that good.",
                "0 is false, 1 is true, right? 1.",
                "Why do web developers always leave a bar? Because of the table layout.",
                "Why was the JavaScript developer sad? Because he didn't know how to 'null' his feelings.",
                "Why did the functional programmer get thrown out of the party? Because he had no side effects.",
                "What do you call a programmer from Finland? Nerdic.",
                "Why did the HTML coder get lost? He couldn't find his </home>.",
                "How do you tell an introverted computer scientist from an extroverted one? The extroverted one looks at *your* shoes when he's talking to you.",
                "Why did the web designer walk out of the restaurant? The table layout was terrible.",
                "I've got a great joke about UDP, but I don't know if you'll get it.",
                "A guy walks into a bar and asks for 1.4 root beers. The bartender says, 'I'll have to charge you for a root beer float.' The guy says, 'Make it a double!'",
                "Why did the programmer quit his job? Because he didn't get arrays (a raise).",
                "Why do programmers hate nature? It has too many bugs."
            ];

            const localChuckJokes = [
                "Chuck Norris doesn't call the wrong number. You answer the wrong phone.",
                "Chuck Norris can drown a fish.",
                "Chuck Norris once kicked a horse in the chin. Its descendants are now known as Giraffes.",
                "Chuck Norris is the reason why Waldo is hiding.",
                "Chuck Norris can lead a horse to water AND make it drink.",
                "When Chuck Norris does a pushup, he isnâ€™t lifting himself up, heâ€™s pushing the Earth down.",
                "Chuck Norris can slam a revolving door.",
                "There is no theory of evolution. Just a list of animals Chuck Norris allows to live.",
                "Chuck Norris can cut through a hot knife with butter.",
                "Chuck Norris doesn't wear a watch. He decides what time it is.",
                "Chuck Norris can light a fire by rubbing two ice cubes together.",
                "Chuck Norris once won a game of Connect Four in three moves.",
                "Chuck Norris can make onions cry.",
                "Chuck Norris has already counted to infinity. Twice.",
                "Outer space exists because it's afraid to be on the same planet as Chuck Norris.",
                "Chuck Norris can hear sign language.",
                "Chuck Norris once got bit by a rattlesnake. After five days of excruciating pain, the snake died.",
                "Chuck Norris destroyed the periodic table, because he only recognizes the element of surprise.",
                "Chuck Norris doesn't breathe air. He holds it hostage.",
                "Chuck Norris can set ants on fire with a magnifying glass. At night."
            ];

            function getRandomLocalJoke(type) {
                let arr;
                if (type === 'dad') arr = localDadJokes;
                else if (type === 'chuck') arr = localChuckJokes;
                else arr = localGenJokes;

                // Extra variety check for local jokes too
                let joke = arr[Math.floor(Math.random() * arr.length)];
                let attempts = 0;
                while (isJokeSeen(joke) && attempts < 10) {
                    joke = arr[Math.floor(Math.random() * arr.length)];
                    attempts++;
                }
                return joke;
            }

            // Audio elements
            const sfxRimshot = document.getElementById('sfx-rimshot');
            const sfxCrickets = document.getElementById('sfx-crickets');

            // Speech Synthesis
            const synth = window.speechSynthesis;
            let currentUtterance = null;

            // Initialization
            document.getElementById('current-year').textContent = new Date().getFullYear();
            let favorites = JSON.parse(localStorage.getItem('premiumJokeFavorites')) || [];
            if (favorites.length === 0) {
                // Migrate old favorites if exist
                const oldFavs = JSON.parse(localStorage.getItem('jokeFavorites')) || [];
                if (oldFavs.length > 0) {
                    favorites = oldFavs;
                    localStorage.setItem('premiumJokeFavorites', JSON.stringify(favorites));
                }
            }

            // Network Monitoring
            window.addEventListener('online', () => {
                document.getElementById('offline-banner').style.display = 'none';
                UI.showToast("Back online!", "success");
            });
            window.addEventListener('offline', () => {
                document.getElementById('offline-banner').style.display = 'block';
                UI.showToast("Connection lost. Operating offline.", "error");
            });

            // State management
            function toggleLoading(isLoading) {
                if (isLoading) {
                    loader.style.display = 'flex';
                    jokeTextElement.style.display = 'none';
                    favBtnIcon.className = 'ri-heart-3-line'; // reset heart
                    stopTTS(); // Stop reading if loading a new one
                } else {
                    loader.style.display = 'none';
                    jokeTextElement.style.display = 'flex';
                }
            }

            function displayJoke(text, setup = null, delivery = null) {
                const fullText = text || `${setup}\n\n${delivery}`;

                if (setup && delivery) {
                    // Two-part interactive joke
                    jokeTextElement.innerHTML = `
                        <div>${UI.escapeHTML(setup)}</div>
                        <button id="reveal-btn" class="reveal-btn"><i class="ri-eye-line"></i> Reveal Punchline</button>
                        <div id="punchline" class="hidden-punchline" style="display:none; margin-top:20px;">${UI.escapeHTML(delivery)}</div>
                    `;

                    document.getElementById('reveal-btn').addEventListener('click', function () {
                        this.style.display = 'none';
                        const p = document.getElementById('punchline');
                        p.style.display = 'block';
                        setTimeout(() => p.classList.add('revealed'), 50);
                        playSFX(sfxRimshot);

                        // Add delivery to TTS if playing, or store for later
                        localStorage.setItem('lastPremiumJoke', fullText);
                    });
                    localStorage.setItem('lastPremiumJoke', fullText);
                } else {
                    // Single part joke
                    jokeTextElement.textContent = fullText;
                    localStorage.setItem('lastPremiumJoke', fullText);
                }

                // Check if already favorited
                if (favorites.includes(fullText)) {
                    favBtnIcon.className = 'ri-heart-3-fill';
                    favBtnIcon.style.color = '#f43f5e';
                } else {
                    favBtnIcon.className = 'ri-heart-3-line';
                    favBtnIcon.style.color = ''; // reset to default css hover rules
                }

                // Trigger animation reset
                jokeTextElement.style.animation = 'none';
                jokeTextElement.offsetHeight; /* trigger reflow */
                jokeTextElement.style.animation = 'fadeIn 0.5s ease-out';
            }

            // --- Interactive Media Logic ---
            function playSFX(audioElement) {
                try {
                    audioElement.currentTime = 0;
                    audioElement.play().catch(e => console.warn("Audio play blocked by browser:", e));
                } catch (e) { }
            }

            function stopTTS() {
                if (synth.speaking) {
                    synth.cancel();
                    ttsBtnIcon.className = 'ri-volume-up-line';
                }
            }

            document.getElementById('tts-btn').addEventListener('click', () => {
                UI.haptic();
                if (synth.speaking) {
                    stopTTS();
                    return;
                }

                let textToRead = localStorage.getItem('lastPremiumJoke') || jokeTextElement.textContent;
                // If punchline is hidden, only read setup for now
                if (document.getElementById('reveal-btn') && document.getElementById('reveal-btn').style.display !== 'none') {
                    textToRead = jokeTextElement.children[0].textContent;
                }

                if (textToRead && !textToRead.includes("Press a category")) {
                    currentUtterance = new SpeechSynthesisUtterance(textToRead);

                    // Try to find a good English voice
                    const voices = synth.getVoices();
                    const enVoice = voices.find(v => v.lang.includes('en-') && !v.name.includes('Google'));
                    if (enVoice) currentUtterance.voice = enVoice;

                    currentUtterance.rate = 0.9;
                    currentUtterance.pitch = 1.1;

                    currentUtterance.onstart = () => ttsBtnIcon.className = 'ri-stop-circle-line';
                    currentUtterance.onend = () => ttsBtnIcon.className = 'ri-volume-up-line';
                    currentUtterance.onerror = () => ttsBtnIcon.className = 'ri-volume-up-line';

                    synth.speak(currentUtterance);
                } else {
                    UI.showToast("Generate a joke first!", "info");
                }
            });

            // Rating System
            document.getElementById('upvote-btn').addEventListener('click', function (e) {
                UI.haptic();
                createFloatingEmoji('ðŸ˜‚', e.clientX, e.clientY);
                UI.showToast("Glad you liked it!", "success");
            });

            document.getElementById('downvote-btn').addEventListener('click', function (e) {
                UI.haptic();
                createFloatingEmoji('ðŸ…', e.clientX, e.clientY);
                playSFX(sfxCrickets);
            });

            function createFloatingEmoji(emoji, x, y) {
                const el = document.createElement('div');
                el.className = 'rating-toast';
                el.textContent = emoji;
                el.style.left = `${x}px`;
                el.style.top = `${y}px`;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 1000);
            }

            // --- Fetching Logic ---
            async function fetchJokeAPI(cat) {
                toggleLoading(true);
                let fetchSuccess = false;
                let attempts = 0;
                const maxAttempts = 3;

                while (!fetchSuccess && attempts < maxAttempts) {
                    try {
                        let res, data;
                        const timestamp = new Date().getTime();

                        if (cat === 'geek') {
                            // Geek Jokes API
                            res = await fetch(`https://geek-jokes.sameerkumar.website/api?format=json&_cb=${timestamp}`);
                            data = await res.json();
                            const jokeCandidate = data.joke;
                            // FILTER: Skip if this API returns a Chuck Norris joke in the Geek category
                            if (jokeCandidate.toLowerCase().includes("chuck norris")) {
                                attempts++;
                                console.warn("Filtered Chuck joke from Geek category");
                                continue;
                            }
                            if (isJokeSeen(jokeCandidate)) { attempts++; continue; }
                            displayJoke(jokeCandidate);
                            markJokeSeen(jokeCandidate);
                            fetchSuccess = true;
                        } else if (cat === 'chuck') {
                            // Chuck Norris API
                            res = await fetch(`https://api.chucknorris.io/jokes/random?_cb=${timestamp}`);
                            data = await res.json();
                            const jokeCandidate = data.value;
                            if (isJokeSeen(jokeCandidate)) { attempts++; continue; }
                            displayJoke(jokeCandidate);
                            markJokeSeen(jokeCandidate);
                            fetchSuccess = true;
                        } else {
                            // Primary JokeAPI
                            const separator = cat.includes('?') ? '&' : '?';
                            const randomizer = `&amount=1&safe-mode&_cb=${timestamp}`;
                            res = await fetch(`https://v2.jokeapi.dev/joke/${cat}${separator}blacklistFlags=nsfw,religious,political,racist,sexist,explicit${randomizer}`);
                            if (!res.ok) throw new Error("API Error");
                            data = await res.json();
                            if (data.error) throw new Error(data.message);

                            let setupCandidate, deliveryCandidate, singleCandidate;
                            if (data.type === 'twopart') {
                                setupCandidate = data.setup;
                                deliveryCandidate = data.delivery;
                                if (isJokeSeen(`${setupCandidate} ${deliveryCandidate}`)) { attempts++; continue; }
                                displayJoke(null, setupCandidate, deliveryCandidate);
                                markJokeSeen(`${setupCandidate} ${deliveryCandidate}`);
                            } else {
                                singleCandidate = data.joke;
                                if (isJokeSeen(singleCandidate)) { attempts++; continue; }
                                displayJoke(singleCandidate);
                                markJokeSeen(singleCandidate);
                            }
                            fetchSuccess = true;
                        }
                    } catch (error) {
                        console.warn("API Attempt failed:", error);
                        attempts++;
                    }
                }

                if (!fetchSuccess) {
                    const localType = (cat === 'geek' || cat === 'Programming' || cat === 'Pun' || cat === 'Spooky') ? 'gen' : cat;
                    displayJoke(getRandomLocalJoke(localType));
                }
                toggleLoading(false);
            }

            async function fetchDadJoke() {
                toggleLoading(true);
                let fetchSuccess = false;
                let attempts = 0;
                const maxAttempts = 3;

                while (!fetchSuccess && attempts < maxAttempts) {
                    try {
                        const timestamp = new Date().getTime();
                        const res = await fetch(`https://official-joke-api.appspot.com/jokes/dad/random?_cb=${timestamp}`);
                        if (!res.ok) throw new Error("Official API Error");
                        const data = await res.json();

                        if (data && data.length > 0) {
                            const randIdx = Math.floor(Math.random() * data.length);
                            const setupCandidate = data[randIdx].setup;
                            const punchlineCandidate = data[randIdx].punchline;

                            if (isJokeSeen(`${setupCandidate} ${punchlineCandidate}`)) { attempts++; continue; }

                            displayJoke(null, setupCandidate, punchlineCandidate);
                            markJokeSeen(`${setupCandidate} ${punchlineCandidate}`);
                            fetchSuccess = true;
                        } else {
                            throw new Error("Empty Array");
                        }
                    } catch (e) {
                        console.warn("Dad API Attempt failed:", e);
                        // Secondary dedicated Dad Joke API
                        try {
                            const dadRes = await fetch('https://icanhazdadjoke.com/', {
                                headers: { 'Accept': 'application/json' }
                            });
                            if (!dadRes.ok) throw new Error("Secondary API Error");
                            const dadData = await dadRes.json();
                            if (isJokeSeen(dadData.joke)) { attempts++; continue; }
                            displayJoke(dadData.joke);
                            markJokeSeen(dadData.joke);
                            fetchSuccess = true;
                        } catch (error) {
                            attempts++;
                        }
                    }
                }

                if (!fetchSuccess) {
                    displayJoke(getRandomLocalJoke('dad'));
                }
                toggleLoading(false);
            }

            // --- Event Listeners ---
            document.querySelectorAll('.fetch-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    UI.haptic();
                    const type = btn.getAttribute('data-type');

                    if (type === 'dad') {
                        fetchDadJoke();
                    } else {
                        fetchJokeAPI(type);
                    }
                });
            });

            // Favorites Handling
            document.getElementById('fav-btn').addEventListener('click', () => {
                UI.haptic();
                const t = localStorage.getItem('lastPremiumJoke') || jokeTextElement.textContent;
                const defaultMsg = "Press a category below to generate your first premium laugh!";

                if (t && t !== defaultMsg && t !== "Oops! The joke servers are on a coffee break. Try another category or check your connection." && t !== "Reddit is sleeping. How about a Coding or Pun joke instead?") {
                    if (!favorites.includes(t)) {
                        favorites.unshift(t);
                        // Save and render
                        localStorage.setItem('premiumJokeFavorites', JSON.stringify(favorites));
                        renderFavs();
                        // Update UI state
                        favBtnIcon.className = 'ri-heart-3-fill';
                        favBtnIcon.style.color = '#f43f5e';
                        UI.showToast("Saved to Hall of Fame", "success");
                    } else {
                        // Un-favorite logic optionally here, or just a toast
                        UI.showToast("Already in your Hall of Fame!", "info");
                    }
                } else {
                    UI.showToast("Generate a joke first before saving!", "info");
                }
            });

            function renderFavs(filter = '') {
                const searchStr = filter.toLowerCase().trim();
                const filtered = favorites.filter(f => f.toLowerCase().includes(searchStr));

                if (favorites.length === 0) {
                    favList.innerHTML = `<p style="text-align:center; color:var(--text-muted); padding: 20px;">No saved jokes yet. Find a good one and hit the heart!</p>`;
                    return;
                }

                if (filtered.length === 0) {
                    favList.innerHTML = `<p style="text-align:center; color:var(--text-muted); padding: 20px;">No jokes match your search.</p>`;
                    return;
                }

                favList.innerHTML = filtered.map((j) => {
                    const originalIndex = favorites.indexOf(j);
                    return `
                        <div class="fav-item">
                            <p>${UI.escapeHTML(j)}</p>
                            <button class="delete-btn" onclick="removeFav(${originalIndex})" aria-label="Remove saved joke">
                                <i class="ri-delete-bin-line"></i> Remove
                            </button>
                        </div>
                    `;
                }).join('');
            }

            // Search Filter
            document.getElementById('fav-search').addEventListener('input', (e) => {
                renderFavs(e.target.value);
            });

            // Bulk Copy
            document.getElementById('copy-all-btn').addEventListener('click', async () => {
                if (favorites.length === 0) {
                    UI.showToast("No jokes to copy!", "info");
                    return;
                }
                UI.haptic();
                const allJokes = favorites.join('\n\n---\n\n');
                try {
                    await navigator.clipboard.writeText(allJokes);
                    UI.showToast(`Copied ${favorites.length} jokes!`, "success");
                } catch (err) {
                    UI.showToast("Failed to copy. Try again.", "error");
                }
            });

            window.removeFav = (index) => {
                UI.haptic();
                const removedItem = favorites.splice(index, 1)[0];
                localStorage.setItem('premiumJokeFavorites', JSON.stringify(favorites));

                // Re-render with current search value
                const searchValue = document.getElementById('fav-search').value;
                renderFavs(searchValue);

                // Reset heart icon if the deleted joke is currently displayed
                const currentStored = localStorage.getItem('lastPremiumJoke');
                if (currentStored === removedItem) {
                    favBtnIcon.className = 'ri-heart-3-line';
                    favBtnIcon.style.color = '';
                }

                UI.showToast("Joke removed", "info");
            };

            // Enhanced Sharing Logic
            document.getElementById('share-btn').addEventListener('click', async () => {
                UI.haptic();
                const joke = localStorage.getItem('lastPremiumJoke') || jokeTextElement.textContent;
                const defaultMsgs = ["Press a category below to generate your first premium laugh!", "Oops! The joke servers are on a coffee break. Try another category or check your connection.", "Reddit is sleeping. How about a Coding or Pun joke instead?"];

                if (defaultMsgs.includes(joke) || !joke) {
                    UI.showToast("Nothing to share yet!", "info");
                    return;
                }

                const shareText = `"${joke}"\n\nâ€” Shared via Premium Joke Central`;

                // Try native Web Share API first
                if (navigator.share) {
                    try {
                        await navigator.share({ title: 'Joke Central', text: shareText });
                        UI.showToast("Shared successfully!", "success");
                        return; // Exit if share API worked
                    } catch (err) {
                        // User cancelled or failed, fall through to clipboard
                        console.log("Share API cancelled/failed", err);
                    }
                }

                // Fallback to clipboard
                try {
                    await navigator.clipboard.writeText(shareText);
                    UI.showToast("Joke copied to clipboard!", "success");
                } catch (err) {
                    UI.showToast("Failed to copy text. Please copy manually.", "error");
                }
            });

            // Report Logic
            document.getElementById('report-btn').addEventListener('click', () => {
                UI.haptic();
                const currentJoke = localStorage.getItem('lastPremiumJoke') || jokeTextElement.textContent;
                const email = "rizzmasterhelpteam@gmail.com"; // Given in original code
                const subject = encodeURIComponent("Joke Report - Joke Central");
                const body = encodeURIComponent("I would like to report this joke for moderation review:\n\n" + currentJoke);

                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
                UI.showToast("Opening mail client...", "info");
            });

            // Initial render
            renderFavs();
            const initJoke = localStorage.getItem('lastPremiumJoke') || "Press a category below to generate your first premium laugh!";
            displayJoke(initJoke);
        });
    </script>
</body>

</html>